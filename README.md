# SiegeD
#### SiegeD(Siege Distributed) — платформа для создания соревнований в формате Attack-Defence CTF

Основное преимущество (и недостаток) системы — ее распределенность.

Практически любой компонент может быть вынесен на отдельный сервер.

Система разделена на бэкенд и фронтенд.
Бэкенд находится в этом репозитории и написан на Go.
Фронтенд написан на PHP и находится в соседнем репе.

В обязанности бэкенда входит:
  * Принимать флаги и пересчитывать очки
  * Запускать чекеры

В обязанности фронтенда входит:
  * Запускать раунды
  * Отображать скорборд

Основные компоненты бэкенда:
  * Роутер-флагов (flag_router)
  * Сервис для добавления флагов (flag_adder)
  * Сервис для принятия флагов (flag_handler)
  * Сервис для запуска чекеров (round_handler)
  
Все сервисы кроме flag_router'а должны запускаться по одному инстансу на сервис в игре.
При этом можно вынести инстансы на разные машины.


Да, это неудобно для маленьких игр, и в данный момент мы работаем над централизированной версией, которую будет очень легко поднять.

Теперь про каждый сервис:
####Round handler
Данный сервис запускает чекер и возвращает статусы и количество флагов / очков для каждой команды.
Сервис запускается по запросу с "фронта", и возвращает результат в JSON.
####Flag handler
Данный сервис обслуживает запросы вида команда N пытается забрать флаг F.
После чего сервис проверяет флаг и пересчитывает очки команд.
К данному сервис обращается сервис Flag Router
####Flag Router
Данный сервис является точкой входа для сдачи флагов.
Сервис находит команду по IP/Токену и передает запрос Flag Handler'у соотвествущего сервиса.
Сервис определяется по первой букве флага.
####Flag Adder
Данный сервис по запросу генерирует новый флаг. 
Нужен для чекеров. 
В обычной версии / в новой этой скорее всего переделаем это.

#### Формула
Формула скоринга — FP * SLA.

FP по каждому сервису высчитывается отдельно и не зависит от других сервисов.

Саму формулу и тесты на нее можно найти в исходниках.
Если интересны подробности — пишите @alagunto / @jnovikov

#### Как запустить ???
Как будет время — я постараюсь подробно описать процесс запуска.

Но суть примерно такая.

Скачиваем:
 * Go
 * gox(для билда Go)
 * dep(для зависимостей)
 * python
 * supervisord

Клоним себе репу / выкачиваем куда удобно

Делаем `dep ensure` в корне. Это поставить все зависимости гошечки.

Заходим в папку scripts. Запускаем `./compile.sh`. Этот скрипт скомпилит проект под MacOs64/ Linux64.
Если нужны другие системы — можете поменять параметры запуска compile.sh. Но под винду не тестил =3

После этого запускаем скрипт-хелпер `generate_game.py`. 
Опции запуска можно посмотреть `python generate_game.py --help`.

Например запуск `python3 generate_game.py --path /tmp/game1 --num 1 --platform linux64 --flags tcp` добавит конфиг для одного сервиса под Linux64 в папку /tmp/game1

После этого переходим в папку и правим файлик с командами teams.yaml и другие конфиг файлы если это нужно.

Далее запускаем  supervisord в этой папке.

`supervisord -c supervisord.conf`

После чего подключаемся через команду `supervisorcrl`

Запускаем сервисы командой `start all`

